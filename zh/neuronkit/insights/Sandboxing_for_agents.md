---
title: "Agent 沙箱实战手册"
layout: neuronkit
permalink: /zh/neuronkit/insights/sandboxing-for-agents/
---

<!-- markdownlint-disable MD041 -->

## 摘要

智能体系统（agentic systems）——使用模型进行规划、决策和行动的软件（通常通过执行脚本或控制 UI）——同时放大了能力与风险。运行不受信任的智能体生成的操作（代码、浏览器自动化、文件操作、网络请求）需要强大且架构合理的隔离机制，以确保单个恶意或存在缺陷的智能体不会升级为系统整体被攻陷或数据泄露。

本白皮书提出了一套适用于智能体系统的实用沙箱方法分类法，对比了不同方法在**安全性、性能、开发者体验**方面的权衡，描述了具体的架构模式（包括常见的“云端决策 / 本地执行器”模式在浏览器智能体中的应用），并给出了在生产环境中选择与组合沙箱技术的建议。文中还引用并链接了关键参考和真实世界的原语（microVM、容器 + seccomp、WebAssembly、浏览器沙箱、基于能力的控制，以及 NeuronKit），供希望实现或评估设计的读者参考。

---

## 1. 引言：为什么智能体需要沙箱

智能体系统能够生成或编排超越文本的动作：它们可能生成代码、点击网页、使用存储的凭证，或操作本地文件。这种能力带来了以下核心风险：

- **不受信任代码执行**：智能体可能生成或接收需要执行的代码（如 Python/JS 片段）。  
- **数据泄露**：指令可能读取令牌、cookies 或文件并发送到远程端点。  
- **权限提升 / 横向移动**：一个智能体进程不应危及共租用户或宿主系统。  
- **供应链 / 持久化风险**：看似良性的操作（如安装包或浏览器扩展）可能带来长期攻击面。  

沙箱通过限制代码的可执行范围和可访问的资源来降低这些风险。

---

## 2. 威胁模型（简要）

在为智能体设计沙箱时，需要明确假设的威胁：

- **宿主被攻陷**（目标：运行任意本地代码 / 访问内核）。  
- **数据泄露**（目标：外泄机密 / cookies / 文件）。  
- **跨租户攻击**（在多租户云环境中：一个租户影响另一个）。  
- **供应链攻击**（智能体导致安装持久化后门）。  
- **UI 操纵与钓鱼**（智能体控制的浏览器 UI 欺骗用户）。  

沙箱的设计必须以所覆盖的威胁范围为驱动。

---

## 3. 沙箱类别分类法

### 3.1 硬件/虚拟机级沙箱（VMs & microVMs）

**描述**  
通过虚拟化实现完整内核级隔离。MicroVM（如 Firecracker）是为短生命周期、低开销和强隔离优化的最小化虚拟机监控器。  

**优点**  

- 强隔离：内核边界阻止大多数宿主攻陷向量。  
- 成熟的攻击面模型，易于推理多租户分离。  

**缺点**  

- 相较进程内解决方案，资源成本与启动延迟更高。  
- 运维复杂度更高（镜像、编排）。  

**适用场景**  

- 在规模化场景下运行完全不受信任的智能体生成代码。  
- 需要内核级分离的场景（任意本地代码执行）。  

---

### 3.2 容器级沙箱 + 内核策略

**描述**  
轻量的操作系统级隔离（命名空间、cgroups），并辅以内核过滤器（seccomp）、LSM（AppArmor/SELinux）、以及运行时沙箱（gVisor、Kata Containers）。  

**优点**  

- 性能较好，工具生态成熟。  
- 可实现细粒度的内核级控制。  

**缺点**  

- 如果存在内核漏洞或逃逸，隔离性弱于完整 VM。  
- 对绝对安全而言配置复杂。  

**适用场景**  

- 中等风险工作负载，对性能要求高并辅以内核加固。  

---

### 3.3 语言/运行时级沙箱（WebAssembly, SFI）

**描述**  
在语言虚拟机中执行，或在进程内通过软件错误隔离实现。WebAssembly（Wasm）是一种可移植的沙箱二进制格式，用于在受限的宿主接口下运行不受信任的代码。  

**优点**  

- 启动延迟极低；资源占用小。  
- 强能力约束。  
- 适合语言无关的插件生态。  

**缺点**  

- 隔离范围仅限进程；宿主运行时漏洞可能被利用。  
- Wasm 本身也存在安全考量。  

**适用场景**  

- 插件模型、算法沙箱、浏览器内执行。  

---

### 3.4 浏览器级沙箱（同源策略、iframe sandbox、CSP）

**描述**  
浏览器实现多层隔离：同源策略、站点隔离、iframe 的 sandbox 属性、CSP、扩展沙箱等。  

**优点**  

- 专为限制网页内容与跨站数据流而设计。  
- 适用于局限在 DOM 与浏览器 API 内的智能体 UI 自动化。  

**缺点**  

- 扩展权限可能被滥用。  
- 需要严格的权限最小化。  

**适用场景**  

- 在浏览器中运行的智能体自动化。  

---

### 3.5 进程 & 内核原语（seccomp、namespaces、AppArmor/SELinux、pledge/jail）

**描述**  
用于加固容器/进程的附加手段：阻止系统调用、限制能力、应用 LSM 策略，或使用操作系统级的 jail 机制。  

**优点**  

- 对资源的细粒度控制。  
- 可在容器/microVM 内部使用。  

**缺点**  

- 需要精细的策略设计。  

**适用场景**  

- 作为容器或进程的补充控制措施。  

---

### 3.6 基于能力与策略执行的沙箱

**描述**  
暴露范围有限的能力（tokens/handles），仅授予特定操作，从而减少环境权限。  

**优点**  

- 遵循最小权限原则。  
- 可实现细粒度的可审计性。  

**缺点**  

- 需要重新设计宿主 API。  

**适用场景**  

- 插件生态、具有限制性操作的浏览器智能体。  

---

### 3.7 语义/意图驱动的沙箱（应用层级）

**描述**  
此类沙箱的边界不在内核、进程或运行时，而在应用语义层。沙箱约束智能体的“意图”（例如“点击按钮 X”、“发起支付 Y”），而不是约束代码执行方式。该模型特别适用于移动应用、超级应用、IoT 与嵌入式智能体：这些场景已有 OS 级沙箱，但无法调解 AI 驱动的意图。其通过**基于策略的能力模型**来调解语义动作。  

它结合了：  

- **云端决策**：智能体规划动作。  
- **本地执行**：浏览器内嵌的 DSL 解释器仅执行允许的步骤。  
- **能力令牌**：最小化、限时的最小权限能力。  
- **分层隔离**：在浏览器沙箱内运行，仅暴露明确、策略批准的动作。  

**优点**  

- 对用户可见动作进行细粒度调解。  
- 轻量级（无 VM/容器开销）。  
- 自然契合能力令牌模型与人机协同审批。  
- 将云端规划与本地可信执行相结合。  

**缺点**  

- 依赖 DSL/策略引擎的正确性。  
- 缺乏内核级屏障。  
- 策略设计复杂。  

**适用场景**  

- 嵌入移动应用、IoT 设备或超级应用的智能体系统。  
- 语义安全（智能体做“什么”）比系统调用安全（智能体如何运行）更重要的场景。  
- 作为 VM/Wasm 等更重隔离的补充。  

---

## 4. 架构与设计模式

### 4.1 云端决策，本地执行  

- 云端智能体规划动作；本地执行器通过 DSL 强制执行。  
- 云端永不接收原始机密。  
- 本地执行器 = 策略执行点（PEP）。  

### 4.2 指令 DSL + 能力令牌  

- 定义可审计的 DSL，带类型化参数。  
- 短期有效的能力令牌。  
- 禁止任意 `eval` 执行。  

### 4.3 双层沙箱：Wasm in microVM

- Wasm 提供插件安全性 + microVM 提供内核防护。  

### 4.4 按任务临时沙箱  

- 每个任务新建环境，执行完后销毁。  

---

## 5. 执行、审计与治理

- **策略决策与执行**：PDP 在云端；PEP 在本地。  
- **可观测性与防篡改**：签名日志、追加写、可重放的执行轨迹。  
- **最小权限与过期**：短期有效的能力令牌。  
- **人机协同**：不可逆操作需用户确认。  

---

## 6. 评估标准

- 隔离强度。  
- 攻击面。  
- 性能与延迟。  
- 开发者体验。  
- 运维成本。  
- 可审计性。  

---

## 7. 实用建议

1. 按风险级别分类操作（低/中/高）。  
2. 对于浏览器智能体采用“云端决策 / 本地执行器”。  
3. 服务端代码：高风险用 microVM，插件模型用 Wasm，或采用混合模式。  
4. 广泛应用内核原语。  
5. 围绕能力设计宿主 API。  
6. 配备审计与取证工具。  
7. 将沙箱生命周期作为持续实践。  
8. 对于 UI 驱动的智能体系统，优先选择 **NeuronKit 等语义沙箱**，而非直接执行 JS。  

---

## 8. 案例与参考

- **Firecracker / microVMs**：轻量但强隔离。  
- **容器 + seccomp**：实用的服务端沙箱。  
- **Wasmtime / WebAssembly**：带能力 API 的可移植运行时。  
- **浏览器沙箱与扩展风险**：CSP、扩展隔离、权限最小化。  
- **NeuronKit Sandbox**：面向智能体–UI 交互的实用语义沙箱。  

---

## 9. 未来方向

- 可证明的 SFI 与形式化验证的运行时。  
- 硬件级隔离（TEE / SGX / SEV）。  
- 基于能力的操作系统与微内核。  
- 标准化的智能体 DSL 与签名能力令牌。  

---

## 10. 结论

智能体系统既强大又充满风险。不存在单一的“最佳沙箱”，而应采取分层方法：  

- 浏览器沙箱 + 本地 PEP 用于 UI。  
- 临时 microVM 用于不受信任的服务端代码。  
- Wasm + 能力 API 用于插件模型。  
- NeuronKit 用于浏览器自动化中的语义执行。  

应假设智能体输出可能存在恶意。最小化环境权限、强制使用能力、对高风险操作要求用户确认，并保留可审计的执行轨迹。  

---

## 附录 A — 简短术语表

- **MicroVM**：最小化虚拟机，TCB 更小，启动更快。  
- **Wasm / WebAssembly**：可移植沙箱运行时的二进制指令格式。  
- **seccomp**：Linux 限制系统调用的机制。  
- **PEP / PDP**：策略执行点 / 策略决策点。  
- **CSP**：内容安全策略。  

---

## 附录 B — 部分参考文献

- Firecracker microVM 文档  
- WebAssembly 安全文档  
- 同源策略（MDN）  
- MicroVM vs 容器（Northflank 博客）  
- 使用 seccomp 的服务端沙箱（Figma 博客）  
- Wasmtime 安全文档  
- Wasm 沙箱项目（GitHub）  
- WebAssembly 安全注意事项（Snyk）  
- Chrome 扩展 manifest / 沙箱文档  
- 恶意浏览器扩展报告（Wired）  
- NeuronKit 设计说明与文档
